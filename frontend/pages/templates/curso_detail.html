{% extends 'base.html' %}
{% load static %}
{% block title %}Detalhes do Curso: {{ curso.nome }}{% endblock %}

{% block extra_css %}
<style>
  #perfis-container {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: calc(100vh - 220px); /* Ajuste conforme a altura da nav e footer + 40px de margem */
    /* overflow-y: auto; Removido para permitir que justify-content funcione */
  }
</style>
{% endblock %}

{% block content %}
  <div id="perfis-container" class="mb-4 shadow-sm p-3 bg-white rounded">
    <div class="">
      <div class="d-flex justify-content-between align-items-end">
        <h2 class="mb-3">{{ curso.nome }} <small class="text-muted">({{ curso.codigo }})</small></h2>
        <p class="lead">{{ curso.descricao|default:"Sem descrição." }}</p>
      </div>
      <div class="d-flex justify-content-between align-items-end">
        <p><strong>Carga Horária Total:</strong> {{ curso.carga_horaria_total }} horas</p>
        <p><strong>Total de Disciplinas Ativas:</strong> {{ curso.total_disciplinas_ativas }}</p>
        <p><strong>Soma da Carga Horária das Disciplinas Ativas:</strong> {{ curso.soma_carga_horaria_disciplinas_ativas }} horas</p>
        <p><strong>Ativo:</strong> {{ curso.ativo|yesno:"Sim,Não" }}</p>
      </div>
      <div>
        <div class="d-flex justify-content-between align-items-end">
          <h3 class="mb-3">Disciplinas</h3>
          <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addDisciplinaModal">Adicionar Disciplina</button>
        </div>
        <div class="mb-3">
          <input type="text" id="disciplinaSearchInput" class="form-control" placeholder="Pesquisar disciplinas por nome ou código...">
        </div>
      </div>
      <div class="table-responsive" id="disciplinasTableContainer">
        <table class="table table-striped table-hover fixed-header">
          <thead>
            <tr>
              <th scope="col">Código</th>
              <th scope="col">Nome</th>
              <th scope="col">Carga Horária</th>
              <th scope="col">Ativo</th>
            </tr>
          </thead>
          <tbody>
            {% if disciplinas.results or disciplinas %}
              {% for disciplina in disciplinas.results|default:disciplinas %}
              <tr>
                <td>{{ disciplina.codigo }}</td>
                <td>{{ disciplina.nome }}</td>
                <td>{{ disciplina.carga_horaria }}</td>
                <td>{{ disciplina.ativo|yesno:"Sim,Não" }}</td>
              </tr>
              {% endfor %}
            {% else %}
            <tr>
              <td colspan="4" class="text-center">Nenhuma disciplina encontrada para este curso.</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
        
    </div>
  
    </div>
    

    <!-- Modal para Adicionar Disciplina -->
    <div class="modal fade" id="addDisciplinaModal" tabindex="-1" aria-labelledby="addDisciplinaModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addDisciplinaModalLabel">Adicionar Nova Disciplina</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            
            <form id="addDisciplinaForm" method="post">
              {% csrf_token %}
              <input type="hidden" id="cursoId" name="curso" value="{{ curso.id }}">
              <div class="mb-3">
                <label for="codigoDisciplina" class="form-label">Código:</label>
                <input type="text" class="form-control" id="codigoDisciplina" name="codigo" required>
              </div>
              <div class="mb-3">
                <label for="nomeDisciplina" class="form-label">Nome:</label>
                <input type="text" class="form-control" id="nomeDisciplina" name="nome" required>
              </div>
              <div class="mb-3">
                <label for="cargaHorariaDisciplina" class="form-label">Carga Horária:</label>
                <input type="number" class="form-control" id="cargaHorariaDisciplina" name="carga_horaria" required>
              </div>
              <button type="submit" class="btn btn-primary">Salvar Disciplina</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex flex-column align-items-center">
      <a href="{% url 'cursos_list' %}" class="btn btn-secondary mt-3">Voltar para Cursos</a>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
{{ disciplinas|json_script:"disciplinas_data" }}
{{ API_BASE_URL|json_script:"api_base_url_data" }}
{{ curso.id|json_script:"curso_id_data" }}
<script src="{% static 'js/curso_detail.js' %}"></script>
{% endblock %}
